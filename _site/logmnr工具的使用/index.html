<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.0.0 --> <title>logmnr工具的使用 - 曼达漫记</title> <meta property="og:title" content="logmnr工具的使用" /> <meta name="description" content="  Logmnr是分析redo和archivelog日志的工具。最近有个数据库archivelog飚得吓人，用logmnr看了下，最终定位，成功解决问题。" /> <meta property="og:description" content="  Logmnr是分析redo和archivelog日志的工具。最近有个数据库archivelog飚得吓人，用logmnr看了下，最终定位，成功解决问题。" /> <link rel="canonical" href="http://liuahuo.github.io/logmnr%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8/" /> <meta property="og:url" content="http://liuahuo.github.io/logmnr%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8/" /> <meta property="og:site_name" content="曼达漫记" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2017-06-24T00:00:00+08:00" /> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "BlogPosting", "headline": "logmnr工具的使用", "datePublished": "2017-06-24T00:00:00+08:00", "description": "  Logmnr是分析redo和archivelog日志的工具。最近有个数据库archivelog飚得吓人，用logmnr看了下，最终定位，成功解决问题。", "url": "http://liuahuo.github.io/logmnr%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8/" } </script> <!-- End Jekyll SEO tag --> <link href="https://fonts.googleapis.com/css?family=Alfa+Slab+One|Source+Serif+Pro" rel="stylesheet"> <link rel="stylesheet" href="/css/main.css"> <link rel="canonical" href="http://liuahuo.github.io/logmnr%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8/"> <link rel="alternate" type="application/rss+xml" title="曼达漫记" href="http://liuahuo.github.io/feed.xml"> </head> <body> <div class="wrapper"> <div class="color-bars-header"><div class="cor-head colr-1"></div><div class="cor-head colr-2"></div><div class="cor-head colr-3"></div><div class="cor-head colr-4"></div><div class="cor-head colr-1"></div><div class="cor-head colr-2"></div><div class="cor-head colr-3"></div><div class="cor-head colr-4"></div></div> <style>.color-bars-header{font-size:0}.cor-head{width:12.5%;height:8px;display:inline-block}.colr-1{background-color:#98C1D9}.colr-2{background-color:#F3DE8A}.colr-3{background-color:#A7D3A6}.colr-4{background-color:#EB9486}@media screen and (max-width: 800px){.color-bars-header{margin: 0 -15px}}</style> <header class="site-header"> <div class="wrapper"> <a href="/"><h1 class="site-title">曼达漫记</h1></a> <nav class="site-nav"> <a href="/" class="nav-link">首页</a> <a href="/category/" class="nav-link">分类</a> <a href="/contact/" class="nav-link">联系</a> </nav> </div> </header> </div> <div class="page-content"> <div class="wrapper"> <article class="post" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post-header"> <h1 class="post-title" itemprop="name headline">logmnr工具的使用</h1> <p class="post-meta"><time datetime="2017-06-24T00:00:00+08:00" itemprop="datePublished">Jun 24, 2017</time></p> </header> <div class="post-content" itemprop="articleBody"> <p>  Logmnr是分析redo和archivelog日志的工具。最近有个数据库archivelog飚得吓人，用logmnr看了下，最终定位，成功解决问题。</p> <p><strong><em>&gt;多说两句</em></strong>：LOGMiner工具实际上由2个新的PL/SQL内建包和4个动态性能视图组成。<br /> 2个内建包分别为：DBMS_LOGMNR_D和DBMS_LOGMNR。<br /> 其中：<br /> DBMS_LOGMNR_D包含以下过程：<br /> dbms_logmnr_d.build()：提取数据字典信息<br /> DBMS_LOGMNR包含 以下过程： <br /> add_logfile:用来增加/剔除用于分析的日志文件<br /> start_logmnr:用来开启日志分析 <br /> end_logmnr:终止分析会话，回收logminer所挪借的内存<br /> 4个动态性能视图：<br /> V$logmnr_dictionary:LogMiner可能利用的数据字典消息<br /> V$logmnr_parameters:目前LogMiner所设定的参数消息<br /> V$logmnr_logs:目前用于分析的日志列表<br /> v$logmnr_contents：日志分析收获</p> <h3 id="logmnr">一、安装logmnr工具</h3> <p>cd $ORACLE_HOME/rdbms/admin<br /> 执行dbmslmd.sql dbmslm.sql 这两个sql，logmnr工具安装成功。 其中dbmslmd.sql用来创建DBMS_LOGMNR_D包，该包用来创建数据字典文件，dbmslm.sql用来创建DBMS_LOGMNR包，该包用来分析日志文件。</p> <p><strong><em>&gt;多说两句</em></strong>： 数据字典文件是可选的，如果没有它，LogMiner解释出来的语句中关于数据字典中的部分（如表名、列名等）和数值都将是16进制的形式，我们是无法理解的。创建数据字典的目的就是让LogMiner引用涉及到内部数据字典中的部分时为实际名字，不是系统内部的16进制。<br /> 举个例子：<br /> INSERT INTO dm_dj_swry(rydm,rymc) VALUES (00005,’张三’); 如果不使用数据字典，LogMiner解释出来的结果将是下面这个样子：<br /> insert into Object#308(col#1,col#2) values (hextoraw(‘c30rte567e436’) ,hextoraw(‘4a6f686e20446f65’));</p> <p><strong><em>&gt;再多说两句</em></strong>：一般我们使用logmnr分析redo/archivelog，分2种情况：在原数据库分析或者在异数据库分析。在原数据库我们可以使用原数据库的数据字典，在异数据库分析我们必须创建被分析数据库的数据字典来辅助分析。<br /> 以下2种情况需要重新创建数据字典：<br /> 1.我们要分析的数据库中的表有变化，影响到库的数据字典也发生变化。<br /> 2.分析另外一个数据库文件的日志时，必须重新生成一遍被分析数据库的数据字典。</p> <p>生成数据字典文件：<br /> 如果想要使用字典文件，数据库至少应该处于mount状态，然后执行dbms_logmnr_d.build()过程将数据字典信息提取到一个外部文件中。 设置初始化参数：UTL_FILE_DIR并确认oracle对该目录有读写权限。这个目录用于存放dbms_logmnr_d.build()过程所产生的字典信息文件。<br /> Exec dbms_logmnr_d.build(dictionary_filename=&gt;”dic.ora”,dictionary_location=&gt;”路径”)</p> <h3 id="section">二、添加想要分析的日志</h3> <p>关键语句为：<br /> exec sys.dbms_logmnr.add_logfile(logfilename =&gt; ‘待分析文件’,options =&gt; dbms_logmnr.new);<br /> exec sys.dbms_logmnr.add_logfile(logfilename =&gt; ‘待分析文件’,options =&gt; dbms_logmnr.addfile);<br /> exec sys.dbms_logmnr.add_logfile(logfilename =&gt; ‘待分析文件’,options =&gt; dbms_logmnr.removefile);</p> <p>实例： exec sys.dbms_logmnr.add_logfile(logfilename =&gt; ‘/u01/app/oracle/fast_recovery_area/CJDF/archivelog/2017_06_21/o1_mf_1_92392_dnlo4odw_.arc’,options =&gt; dbms_logmnr.new);<br /> exec sys.dbms_logmnr.add_logfile(logfilename =&gt; ‘/u01/app/oracle/fast_recovery_area/CJDF/archivelog/2017_06_21/o1_mf_1_92393_dnlo7b5z_.arc’,options =&gt; dbms_logmnr.addfile);<br /> exec sys.dbms_logmnr.add_logfile(logfilename =&gt; ‘/u01/app/oracle/fast_recovery_area/CJDF/archivelog/2017_06_21/o1_mf_1_92394_dnlr6p1d_.arc’,options =&gt; dbms_logmnr.addfile);<br /> exec sys.dbms_logmnr.add_logfile(logfilename =&gt; ‘/u01/app/oracle/fast_recovery_area/CJDF/archivelog/2017_06_21/o1_mf_1_92395_dnlsdmh7_.arc’,options =&gt; dbms_logmnr.addfile);<br /> exec sys.dbms_logmnr.add_logfile(logfilename =&gt; ‘/u01/app/oracle/fast_recovery_area/CJDF/archivelog/2017_06_21/o1_mf_1_92396_dnlsofvg_.arc’,options =&gt; dbms_logmnr.addfile);<br /> exec sys.dbms_logmnr.add_logfile(logfilename =&gt; ‘/u01/app/oracle/fast_recovery_area/CJDF/archivelog/2017_06_21/o1_mf_1_92397_dnmfrl1j_.arc’,options =&gt; dbms_logmnr.addfile);<br /> exec sys.dbms_logmnr.add_logfile(logfilename =&gt; ‘/u01/app/oracle/fast_recovery_area/CJDF/archivelog/2017_06_21/o1_mf_1_92398_dnmzcct1_.arc’,options =&gt; dbms_logmnr.addfile);<br /> exec sys.dbms_logmnr.add_logfile(logfilename =&gt; ‘/u01/app/oracle/fast_recovery_area/CJDF/archivelog/2017_06_21/o1_mf_1_92399_dnnkjj8r_.arc’,options =&gt; dbms_logmnr.addfile);<br /> exec sys.dbms_logmnr.add_logfile(logfilename =&gt; ‘/u01/app/oracle/fast_recovery_area/CJDF/archivelog/2017_06_21/o1_mf_1_92400_dno0k0t7_.arc’,options =&gt; dbms_logmnr.addfile);</p> <h3 id="section-1">三、 开始分析</h3> <p>exec sys.dbms_logmnr.start_logmnr(options =&gt; sys.dbms_logmnr.dict_from_online_catalog);</p> <p>exec sys.dbms_logmnr.start_logmnr(DictfileName=&gt;’生成的数据字典文件’);</p> <h3 id="section-2">四、查看分析结果</h3> <p>select seg_owner,count(*) from v$logmnr_contents group by seg_owner; 按照表用户查看数据库操作数量，定位到CJDF用户，操作量异常。<br /> SQL&gt; select seg_owner,count(*) from v$logmnr_contents group by seg_owner;</p> <table> <thead> <tr> <th>SEG_OWNER</th> <th style="text-align: center">COUNT(*)</th> </tr> </thead> <tbody> <tr> <td> </td> <td style="text-align: center">33451</td> </tr> <tr> <td>SYS</td> <td style="text-align: center">24349</td> </tr> <tr> <td>CJDF</td> <td style="text-align: center">3597313</td> </tr> <tr> <td>SYSMAN</td> <td style="text-align: center">5251</td> </tr> </tbody> </table> <p>继续定位，定位到表级别的操作量异常，反馈给开发，问题解决，done。<br /> SQL&gt; select count(*) from v$logmnr_contents where seg_owner=’CJDF’ and sql_redo=’Unsupported’ and table_name=’T_APP120_TEST’;</p> <p>COUNT(*)<br /> 3248545</p> <h3 id="section-3">五、结束分析</h3> <p>exec dbms_logmnr.end_logmnr;</p> <h3 id="section-4">六、功能及用途：</h3> <p>1． 追踪数据库的变化：可以离线的跟踪数据库的变化，而不会影响在线系统的性能。<br /> 2． 回退数据库的变化：回退特定的变化数据。<br /> 3． 优化和扩容计划：可通过分析日志文件中的数据以分析数据增长模式。</p> </div> </article> <!----> <div id="disqus_thread"></div> <script defer> (function() { var d = document, s = d.createElement('script'); s.src = '//webjeda-demo.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> <!----> <!--<h2> 分类 </h2> <ul class="category-list"> <li> <a href="/categories/docker"> docker (4) </a> </li> <li> <a href="/categories/linux"> linux (1) </a> </li> <li> <a href="/categories/git"> git (1) </a> </li> <li> <a href="/categories/大数据"> 大数据 (1) </a> </li> <li style="background-color: #444"> <a href="/categories/oracle"> oracle (4) </a> </li> <li> <a href="/categories/数据分析"> 数据分析 (3) </a> </li> <li> <a href="/categories/sql语句"> sql语句 (2) </a> </li> <li> <a href="/categories/markdown语法"> markdown语法 (1) </a> </li> </ul>--> </div> </div> <div class="wrapper"> <footer class="site-footer"> <div class="wrapper"> </div> </footer> <div class="color-bars-header"><div class="cor-head colr-1"></div><div class="cor-head colr-2"></div><div class="cor-head colr-3"></div><div class="cor-head colr-4"></div><div class="cor-head colr-1"></div><div class="cor-head colr-2"></div><div class="cor-head colr-3"></div><div class="cor-head colr-4"></div></div> </div> <!-- Google Analytics Tracking code --> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-83979019-1', 'auto'); ga('send', 'pageview'); </script> </body> </html>
